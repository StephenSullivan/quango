-#content_for :trends do
  =# render :partial => "discussion_topics", :object => @tag_cloud

= javascript_include_merged :show

- @current_class = 'discussion hentry entry post'

- show_close_request_form = !@discussion.closed && logged_in? && @discussion.can_be_requested_to_close_by?(current_user)
- show_open_request_form = @discussion.closed && logged_in? && @discussion.can_be_requested_to_open_by?(current_user)

- if logged_in?
  - if current_user.mod_of?(current_group) && @discussion.closed
    - show_close_request_form = (@discussion.close_reason.user_id == current_user.id)
  - @flag = current_user.has_flagged?(@discussion) || Flag.new

- @flag ||= Flag.new

- if show_open_request_form
  - @open_request = current_user.has_requested_to_open?(@discussion) || OpenRequest.new

- if show_close_request_form
  - @close_request = @discussion.close_requests.detect{ |rq| rq.user_id == current_user.id } || CloseRequest.new(:reason => "dupe")

- discussion_body = find_and_preserve(shapado_auto_link(markdown(@discussion.body.present? ? @discussion.body : @discussion.title)))

- content_for :head do
  %meta{:name => "keywords", :content => clean_seo_keywords(@discussion.tags.dup, @discussion.title)}
  %meta{:name => "description", :content => discussion_body.gsub(/<\/?[^>]*>/, "")[0, 255] }
  %link{:rel => "canonical", :href => discussion_url(@discussion) }

- content_for :subtabs do

  %h1.navtitle.title.entry-title
    &= @discussion.title
    - if @discussion.closed
      =" [#{t("closed", :scope => "activerecord.attributes.discussion").upcase}]"

- source = discussion_path(@discussion)
= error_messages_for 'answer'

- content_for :main do
  = show_flash_messages(:class => "flash", :markdown => true)
  #discussion-body-col.commentable.markdown
    %a{:name => @discussion.id}
    =render :partial => "toolbox"
    #body
      - if @discussion.closed && @discussion.close_reason
        #close_reason
          = t(".close_reason")
          = t(@discussion.close_reason.reason, :scope=>"close_requests.form")
          - if !@discussion.close_reason.comment.empty?
            .comment
              =find_and_preserve(shapado_auto_link(@discussion.close_reason.comment))
      .entry-title
        = @discussion.title

      .entry-content
        = discussion_body
    .tag-list
      - @discussion.tags.each do |tag|
        %span.tag
          = link_to h(tag), url_for(:controller => "discussions", :action => "index", :tags => tag), :rel => "tag"
      - if logged_in? && (current_user.can_modify?(@discussion) || current_user.can_retag_others_discussions_on?(current_group))
        %span.retag
          = link_to t('.retag'), retag_discussion_path(@discussion), :id => 'retag'

    =render :partial => "user_info"
    =render :partial => "controls"
  

    - if logged_in?
      = link_to t("comments.shared.add_comment"), new_discussion_comment_path(@discussion), :id => "add_comment_link", :rel => 'nofollow'

    .comments
      -@discussion.comments.each do |comment|
        = render :partial => "comments/comment", :object => comment, :locals => {:source => source, :mini => true}
    .clear
    .forms
      .comment-form-discussion
        -form_tag discussion_comments_path(@discussion), :class => "form commentForm nestedAnswerForm", :id => "add_comment_form" do
          -@comment = Comment.new
          = render :partial => "comments/form", :locals => {:source => source, :commentable => @discussion, :mode=>"discussion"}
          .group.navform
            = submit_tag t("comments.shared.comment_submit"), :class => "button"
            = t("global.or")
            = link_to t('scaffold.cancel'), '', :class => 'cancel_comment'

  %a{:name=>"answers"}
  #answers
    .secondary-navigation{:class => @active_subtab.to_s}
      .navtitle
        = t("discussions.index.answers_title", :count => @answers.total_entries + (@discussion.accepted ? 1 : 0))

      %ul
        %li.newest
          = link_to t("discussions.index.newest"), discussion_path(@discussion, :sort=>"newest", :anchor => "answers"), :rel => "nofollow"
        %li.votes
          = link_to t("discussions.index.votes"), discussion_path(@discussion, :sort=>"votes", :anchor => "answers"), :rel => "nofollow"
        %li.oldest
          = link_to t("discussions.index.oldest"), discussion_path(@discussion, :sort=>"oldest", :anchor => "answers"), :rel => "nofollow"
      .clear
    .block
      - if @discussion.accepted
        -solution = @discussion.answer
        =render :partial=> "answer", :locals=> {:discussion => @discussion, :answer => solution} unless solution.nil?
      .hentry
        -@answers.each do |answer|
          =render :partial=> "answer", :locals=> {:discussion => @discussion, :answer => answer}
      =will_paginate(@answers)

  -unless @discussion.closed
    %a{:name=>"to_answer"}
    -form_for @answer, :url => discussion_answers_path(@discussion.id), :html => {:class => "form mainAnswerForm"} do |f|
      = render :partial => "answers/form", :locals => {:f => f, :markdown => true, :mode => "discussion"}
      .group.navform
        .right
          =# f.label :wiki, "Wiki", :class => "radio"
          =# f.check_box :wiki, :class => "checkbox"
        = submit_tag t('answers.form.submit'), :class => "button"
      .clear

-content_for :sidebar do
  #sidebar
    - if logged_in? && (current_user.mod_of?(current_group) || current_user.can_view_offensive_counts_on?(current_group))
      -unless @discussion.flags.count == 0
        .block
          %h3
            = t(:flags, :scope => "activerecord.models")
          .content
            = render :partial => "flags/list", :locals => {:flaggeable => @discussion}

      -unless @discussion.close_requests.size == 0
        .block
          %h3
            = t(:prural_name, :scope => "close_requests.model")
          .content
            = render :partial => "close_requests/list", :locals => {:discussion => @discussion}

      -unless @discussion.open_requests.size == 0
        .block
          %h3
            = t(:prural_name, :scope => "open_requests.model")
          .content
            = render :partial => "open_requests/list", :locals => {:discussion => @discussion}

    .block
      %h3
        = t('.tags', :default => [:"layouts.application.tags", :"activerecord.attributes.user.tags", "tags"])
      = render :partial => "shared/tag_list", :object => @tag_cloud, :locals => { :extra_params => {:controller => "discussions", :action => "index"} }
      .clear

    - if @discussion.badges.size > 0
      .block
        %h3
          = t('badges', :scope => "activerecord.models")
        .content
          %ul.list
            -@discussion.badges.each do |badge|
              %li
                = render :partial => "badges/badge", :object => badge, :locals => {:hide_user => false}

    .block.stats
      - if @discussion.group_id != current_group.id
        = t(".asked_on")
        &= @discussion.group.name

      .entry
        .text.asked
          = t('activerecord.attributes.discussion.created_at')
          .data
            = t("time.ago", :time => time_ago_in_words(@discussion.created_at))
      .entry
        .text.viewed
          = t('.viewed')
        .data
          = t('number.x_time', :count => number_with_delimiter(@discussion.views_count))
      .entry
        .text.last_activity
          = t(".last_activity")
        .data.updated{:title => @discussion.activity_at, :class => "relativetime"}
          = t("time.ago", :time => time_ago_in_words(@discussion.activity_at))

    -related_discussions = Discussion.related_discussions(@discussion, :language => find_languages)
    - if !related_discussions.empty?
      .block
        %h3
          =t(".related_discussions")
        .content
          %ul.list
            -related_discussions.each do |rq|
              %li
                = link_to h(rq.title), discussion_path(rq), :title => truncate(strip_tags(rq.body), :length => 200)
